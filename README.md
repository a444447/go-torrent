# Building a BitTorrent client from ground


# Introduction

BitTorrent æ˜¯ä¸€ä¸ªåœ¨äº’è”ç½‘ä¸Šä¸‹è½½å’Œåˆ†äº«æ–‡ä»¶çš„åè®®ã€‚ä¼ ç»Ÿçš„ client/server å…³ç³»ä¸­ï¼Œä¸‹è½½è€…ä»¬éƒ½è¿æ¥åˆ°ä¸€ä¸ªä¸­å¤®æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼šåœ¨ Netflix ä¸Šçœ‹ç”µå½±ï¼Œæˆ–è€…åŠ è½½ä½ æ­£åœ¨é˜…è¯»çš„ç½‘é¡µï¼‰ï¼Œè€Œåœ¨ BitTorrent ç½‘ç»œä¸­ï¼Œä¸‹è½½è€…è¢«ç§°ä¸º peersï¼Œä»–ä»¬äº’ç›¸ä¹‹é—´ä¸‹è½½æ–‡ä»¶çš„æŸä¸€ä¸ªç‰‡æ®µâ€”â€”è¿™å°±æ˜¯è¢«ç§°ä¸º peer-to-peerï¼ˆP2Pï¼‰ çš„åè®®ã€‚




ä¸­å¿ƒæ¨¡å¼:
ç¼ºç‚¹:å¦‚æœç¦»Serverå¾ˆè¿œï¼Œåˆ™è½¬æ’­æ—¶å»¶å¾ˆé«˜

P2Pæ¨¡å¼:

æ‰€æœ‰å‚ä¸ä¸‹è½½çš„ä¸‹è½½æ–¹éƒ½æ˜¯peerã€‚åŠ è½½ä¸œè¥¿çš„æ—¶å€™å¯ä»¥ç›´æ¥é€šè¿‡å·²ç»æœ‰ç›¸åº”èµ„æºçš„peerä¸­
ä¸‹è½½è¯¥èµ„æº(äººäººä¸ºæˆ‘,æˆ‘ä¸ºäººäºº)ã€‚

äº‰è®®:å­˜åœ¨å¾ˆå¤šçš„ç‰ˆæƒé—®é¢˜

ä¸ºäº†å®ŒæˆP2Pæ¨¡å¼æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„é—®é¢˜:

1. å¦‚ä½•æ‰¾åˆ°peers
    
> **æ‰¾åˆ°ä¸€ä¸ªä¸­å¿ƒåŒ–çš„ç«™ç‚¹tracker,å®ƒèƒ½æä¾›æ‹¥æœ‰èµ„æºçš„peersçš„åå•**\
> ä¾‹å¦‚ä»¥å‰å›½å†…æµè¡Œçš„PTç«™:å®ƒä½œä¸ºtrackeræä¾›peersåå•ï¼ŒåŒæ—¶ä½ ä¸‹è½½èµ„æºä¹Ÿä¼šæˆä¸ºå…¶ä¸­çš„peerã€‚




2. å¦‚ä½•ä¸peersåä½œå®Œæˆä¸‹è½½

BitTorrentä¸»è¦åŸç†æ˜¯éœ€è¦æŠŠæä¾›ä¸‹è½½çš„æ–‡ä»¶è™šæ‹Ÿåˆ†æˆå¤§å°ç›¸ç­‰çš„å—ï¼Œå—å¤§å°å¿…é¡»ä¸º2kçš„æ•´æ•°æ¬¡æ–¹ï¼ˆç”±äºæ˜¯è™šæ‹Ÿåˆ†å—ï¼Œç¡¬ç›˜ä¸Šå¹¶ä¸äº§ç”Ÿå„ä¸ªå—æ–‡ä»¶ï¼‰ï¼Œå¹¶æŠŠæ¯ä¸ªå—çš„ç´¢å¼•ä¿¡æ¯å’ŒHashéªŒè¯ç å†™å…¥ç§å­æ–‡ä»¶ä¸­

ç°åœ¨æˆ‘ä»¬æ€»ç»“ä¸€äº›æ„é€ ä¸€ä¸ªBitTorrentå®¢æœç«¯çš„æ­¥éª¤:
+ step1 Bencodeåº“ -> åºåˆ—åŒ–ä¸ååºåˆ—åŒ–
+ step2 torrentè§£ææ–‡ä»¶ -> è·å¾—tracker å’Œ info
+ step3 trackeræ¨¡å—  -> peersä¿¡æ¯
+ step4 downloadæ¨¡å— -> piecesä¸æ ¡éªŒ
+ step5 assember -> æŠŠpiecesæ‹¼è£…ä¸ºfile


# Finding Peers



## .torrent file

.torrent æ–‡ä»¶æè¿°äº†å¯ä¸‹è½½æ–‡ä»¶çš„å†…å®¹å’Œè¿æ¥åˆ°ç‰¹å®š tracker çš„ä¿¡æ¯ï¼Œè€Œè¿™å°±æ˜¯å¼€å§‹ä¸‹è½½ä¸€ä¸ª torrent æ‰€éœ€è¦çš„å…¨éƒ¨ã€‚Debian çš„ .torrent æ–‡ä»¶é•¿è¿™æ ·ï¼š

```
d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:"Debian CD from cdimage.debian.org"13:creation datei1573903810e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.isoe4:infod6:lengthi351272960e4:name31:debian-10.2.0-amd64-netinst.iso12:piece lengthi262144e6:pieces26800:ï¿½ï¿½ï¿½ï¿½ï¿½PSï¿½^ï¿½ï¿½ (binary blob of the hashes of each piece)ee
```



è¿™ä¸€å †ä¹±ç è¢«ç”¨ä¸€ç§ç§°ä¸º Bencodeï¼ˆå‘éŸ³ä¸º bee-encodeï¼‰çš„æ–¹æ³•è¿›è¡Œäº†ç¼–ç ï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•è§£ç å®ƒã€‚
BencodeåŒ…å«å››ç§ç±»å‹:string,int,slice,dictionary

Bencodeè™½ç„¶ä¸å¦‚JSONä¸€æ ·å¯è¯»ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªä¼˜åŠ¿å°±æ˜¯å¾ˆå®¹æ˜“ä»æµä¸­è½¬æ¢ï¼Œ
>é€‚åˆç½‘ç»œä¼ è¾“(ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦çš„è¯»å–)\
> æ¯”å¦‚ç»™å‡º`8:announce`æˆ‘ä»¬ä»…æ ¹æ®ç¬¬ä¸€ä¸ªå­—ç¬¦å°±å¯ä»¥çŸ¥é“é•¿åº¦å’Œç±»å‹
> å› æ­¤æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“æ¥ä¸‹æ¥èµ°ä»€ä¹ˆé€»è¾‘

å› ä¸ºstringå‰é¢çš„ç¼–ç ä»£è¡¨äº†ä»–ä»¬çš„é•¿åº¦:

ä¾‹å¦‚,æ•°å­—`7`è¡¨ç¤ºä¸º`i7e`,`4:spam`è¡¨ç¤ºå­—ç¬¦ä¸²spam,`l4:spami7e` è¡¨ç¤º `['spam',7]`ï¼Œ`d4:spami7ee` è¡¨ç¤º `{spam:7}`ã€‚
> æ³¨æ„:`list`,`int`,`dict`éƒ½æ˜¯ä»¥l,i,då¼€å¤´ï¼Œeç»“å°¾

